name: Test Caffeine Action

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  test-action:
    name: Test Caffeine Action
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Create test blueprint and expectation files
      - name: Create test Caffeine files
        run: |
          mkdir -p expectations/org/team output

          # Create a valid blueprint file
          cat > blueprints.json << 'EOF'
          {
            "blueprints": [
              {
                "name": "availability_slo",
                "artifact_ref": "SLO",
                "params": {
                  "service_name": "String"
                },
                "inputs": {
                  "vendor": "datadog",
                  "value": "numerator / denominator",
                  "queries": {
                    "numerator": "sum:http.requests{service:$$service_name->service_name$$,!status:5xx}",
                    "denominator": "sum:http.requests{service:$$service_name->service_name$$}"
                  }
                }
              }
            ]
          }
          EOF

          # Create a valid expectation file (must be nested in org/team structure)
          cat > expectations/org/team/api.json << 'EOF'
          {
            "expectations": [
              {
                "name": "API Service Availability",
                "blueprint_ref": "availability_slo",
                "inputs": {
                  "service_name": "api-gateway",
                  "threshold": 99.9,
                  "window_in_days": 30
                }
              }
            ]
          }
          EOF

      - name: Run Caffeine Language Action
        uses: ./
        with:
          blueprint_file: 'blueprints.json'
          expectations_dir: 'expectations'
          output_path: 'output'

      - name: Verify output exists
        run: |
          echo "Generated Terraform:"
          cat output/main.tf
